<div class="container searchindex center">
  <h3>
    <% if language=='en' %>
      Registration Number
    <% elsif language=='sc' %>
      报名编号
    <% else %>
      報名編號
    <% end %>
  <%= @register.merchant_trade_no %></h3>
  <hr class="hr">
  <div class="register_holder">
    <% if @register.prohibit==true %>
      <p class="bg-danger">
        <% if language=='en' %>
          Blocked
        <% elsif language=='sc' %>
          已封锁
        <% else %>
          已封鎖
        <% end %>
      </p>
    <% else %>
      <% if @register.paystatus==3 %>
        <p class="bg-success">
          <% if language=='en' %>
            Paid
          <% elsif language=='sc' %>
            已付款
          <% else %>
            已付款
          <% end %>
        </p>
      <% elsif @register.paystatus==1 %>
        <p class="bg-danger">
          <% if language=='en' %>
            Billing Amount Error
          <% elsif language=='sc' %>
            帐单金额错误
          <% else %>
            帳單金額錯誤
          <% end %>
        </p>
      <% else %>
        <p class="bg-danger">
          <% if language=='en' %>
            Unpaid
          <% elsif language=='sc' %>
            尚未付款
          <% else %>
            尚未付款
          <% end %>
        </p>
      <% end %>
    <% end %>
  </div>
  <div class="row">
    <div class="col-md-6 col-md-offset-3">
      <tbody>
        <table class="table table-hover">
          <tr>
            <% if language=='en' %>
              <td>Full Name</td>
            <% elsif language=='sc' %>
              <td>报名者姓名</td>
            <% else %>
              <td>報名者姓名</td>
            <% end %>
            <td><%= @register.name %></td>
          </tr>
          <tr>
            <td>E-mail</td>
            <td><%= @register.email %></td>
          </tr>
          <% if @register.paystatus==1 || @register.paystatus==3 %>
            <tr>
              <% if language=='en' %>
                <td>Payment Amount</td>
              <% elsif language=='sc' %>
                <td>付款金额</td>
              <% else %>
                <td>付款金額</td>
              <% end %>
              <td><%= @transaction.params["TradeAmt"] %></td>
            </tr>
            <tr>
              <% if language=='en' %>
                <td>Payment Date</td>
              <% elsif language=='sc' %>
                <td>付款日期</td>
              <% else %>
                <td>付款日期</td>
              <% end %>
              <td><%= @transaction.params["PaymentDate"] %></td>
            </tr>
            <tr>
              <% if language=='en' %>
                <td>Payment Method</td>
              <% elsif language=='sc' %>
                <td>付款方式</td>
              <% else %>
                <td>付款方式</td>
              <% end %>
              <td><%= @transaction.params["PaymentType"] %></td>
            </tr>
          <% end %>
        </table>
      </tbody>
      
    </div>
  </div>

  <% if @register.prohibit==false %>
    <% if @register.paystatus==2 %>
      <div>
        <%= form_tag allpayform_path, method: :get do %>
          <%= hidden_field_tag :register, params[:register],value: @register.email %>
          <% if language=='en' %>
            <%=submit_tag "PAY", name: nil, class: "btn btn-lg btn-success" %>
          <% elsif language=='sc' %>
            <%=submit_tag "付款", name: nil, class: "btn btn-lg btn-success" %>
          <% else %>
            <%=submit_tag "付款", name: nil, class: "btn btn-lg btn-success" %>
          <% end %>
        <% end %>
      </div>
    <% elsif @register.paystatus==3 %>
      <% if hasTdmfile?(@register) %>
        <div style="padding: 50px 0;">
          <% if language=='en' %>
          <% elsif language=='sc' %>
            <h3>档案上传说明<i class="fa fa-file"></i></h3>
            <br>
            <h4>3D列印设计图上传限IGS档</h4>
            <h4>请以作品名称命名欲上传之3D列印设计图档  <small>例：”恐龙骨架模型.igs“</small></h4>
            <h4>并至少上传最少一张，最多三张之该模型照片</h4>
          <% else %>
            <h3>檔案上傳說明<i class="fa fa-file"></i></h3>
            <br>
            <h4>3D列印設計圖上傳限IGS檔</h4>
            <h4>請以作品名稱命名欲上傳之3D列印設計圖檔  <small>例：”恐龍骨架模型.igs“</small></h4>
            <h4>並至少上傳最少一張，最多三張之該模型照片</h4>
          <% end %>
        </div>
        <%= form_for(@tdmfile, html: { multipart: true }) do |f| %>
          <input type="hidden" name="email" id="email" value="<%= @register.email %>" />
          <input type="hidden" name="name" id="name" value="<%= @register.name %>" />
          <div class="row igs_holder">
            <div class="col-xs-12 col-md-12">
              <% if language=='en' %>
                <%= f.file_field :igsfile, "data-buttonText":'Choose File', "data-placeholder":'IGS', class:'filestyle', style:"display:inline-block", accept: '.igs' %>
              <% elsif language=='sc' %>
                <%= f.file_field :igsfile, "data-buttonText":'选择档案', "data-placeholder":'IGS', class:'filestyle', style:"display:inline-block", accept: '.igs' %>
              <% else %>
                <%= f.file_field :igsfile, "data-buttonText":'選擇檔案', "data-placeholder":'IGS', class:'filestyle', style:"display:inline-block", accept: '.igs' %>
              <% end %>
            </div>
            <div class="error_holder">
              <% if language=='en' %>
                <p class="igserror hidden igstype">File format error</p>
                <p class="igserror hidden igssize">File size exceeds 5MB, please choose a smaller file</p>
              <% elsif language=='sc' %>
                <p class="igserror hidden igstype">档案格式错误</p>
                <p class="igserror hidden igssize">档案大小超过5MB，请选择更小的档案</p>
              <% else %>
                <p class="igserror hidden igstype">檔案格式錯誤</p>
                <p class="igserror hidden igssize">檔案大小超過5MB，請選擇更小的檔案</p>
              <% end %>
            </div>
          </div>
          <div class="row picture_holder">
            <% 3.times do |n| %>
              <div class="col-xs-4 col-md-4">
                <div id="picture<%= n+1 %>Preview" class="picturePreview">
                  <div class="delete_holder">
                    <div id="picture<%= n+1 %>" class="deleteButton">×</div>
                  </div>
                </div>
                <div style="display: inline-block;">
                  <% if language=='en' %>
                    <%= f.file_field :picture1, id:"picture#{n+1}file", class:"filestyle uploadFile", name:"tdmfile[picture#{n+1}]", "data-input":false, "data-badge":false, "data-buttonText":'Select Image', "data-iconName":'glyphicon glyphicon-camera', accept: 'image/jpeg,image/png' %>
                  <% elsif language=='sc' %>
                    <%= f.file_field :picture1, id:"picture#{n+1}file", class:"filestyle uploadFile", name:"tdmfile[picture#{n+1}]", "data-input":false, "data-badge":false, "data-buttonText":'选择图片', "data-iconName":'glyphicon glyphicon-camera', accept: 'image/jpeg,image/png' %>
                  <% else %>
                    <%= f.file_field :picture1, id:"picture#{n+1}file", class:"filestyle uploadFile", name:"tdmfile[picture#{n+1}]", "data-input":false, "data-badge":false, "data-buttonText":'選擇圖片', "data-iconName":'glyphicon glyphicon-camera', accept: 'image/jpeg,image/png' %>
                  <% end %>
                </div>
                <div style="position: absolute;right:30%;">
                  <% if language=='en' %>
                    <p class="pictureerror hidden picture<%= n+1 %>type">File format error</p>
                  <% elsif language=='sc' %>
                    <p class="pictureerror hidden picture<%= n+1 %>type">档案格式错误</p>
                  <% else %>
                    <p class="pictureerror hidden picture<%= n+1 %>type">檔案格式錯誤</p>
                  <% end %>
                </div>
                <div style="position: absolute;">
                  <% if language=='en' %>
                    <p class="pictureerror hidden picture<%= n+1 %>size">File size exceeds 800KB, please choose a smaller file</p>
                  <% elsif language=='sc' %>
                    <p class="pictureerror hidden picture<%= n+1 %>size">档案大小超过800KB，请选择更小的档案</p>
                  <% else %>
                    <p class="pictureerror hidden picture<%= n+1 %>size">檔案大小超過800KB，請選擇更小的檔案</p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
          <div>
            <% if language=='en' %>
              <%= f.submit "UPLOAD", class: "btn btn-primary btn-lg", id: "filesubmit" %>
            <% elsif language=='sc' %>
              <%= f.submit "确定并上传", class: "btn btn-primary btn-lg", id: "filesubmit" %>
            <% else %>
              <%= f.submit "確定並上傳", class: "btn btn-primary btn-lg", id: "filesubmit" %>
            <% end %>
          </div>
        <% end %>
        
        <script>
          function pictureDelete(id){
            $('#'+id+'Preview').css("background-image","url()");
            $('#'+id+"file").filestyle('clear');
            $('#'+id).css('display','none');
          }
          $('.deleteButton').click(function(){
            var id=$(this).attr('id')
            pictureDelete(id)
          })
          $('#tdmfile_igsfile').on("change",function(){
            if($(this).val()==""){
              $(this).filestyle('clear');
            }
          })
          $('.uploadFile').on("change",function(){
            var size_in_megabytes = this.files[0].size/1024/1024;
            var n;
            if ($(this).is("#picture1file")){n="picture1"}
            if ($(this).is("#picture2file")){n="picture2"}
            if ($(this).is("#picture3file")){n="picture3"}
            if($('#'+n+'file').val()==""){
              pictureDelete(n)
            }
            else{
              if(size_in_megabytes>0.8){
                pictureDelete(n)
                $('.'+n+'type').addClass('hidden');
                $('.'+n+'size').removeClass('hidden');
              }
            }
          })
          checkFileSize($('#tdmfile_igsfile'))
          checkFileSize($('#picture1file'))
          checkFileSize($('#picture2file'))
          checkFileSize($('#picture3file'))
          $('#new_tdmfile').submit(function(){
            if($('#tdmfile_igsfile').val()!=""){
              if(($('#picture1file').val()!="") || ($('#picture2file').val()!="") || ($('#picture3file').val()!="")){return true}
            }
            <% if language=='en' %>
              alert('The uploaded file is not complete');
            <% elsif language=='sc' %>
              alert('上传的档案不完整');
            <% else %>
              alert('上傳的檔案不完整');
            <% end %>
            return false
          })
          function checkFileSize(file){
            file.bind('change', function(){
              var size_in_megabytes = this.files[0].size/1024/1024;
              var ext=file.val().split('.').pop().toLowerCase();
              if(file.is('#tdmfile_igsfile')){
                if($.inArray(ext,['igs'])==-1){
                  $('.igstype').removeClass('hidden');
                  $('#tdmfile_igsfile').filestyle('clear');
                  resetFormElement($(this))
                }
                else{
                  if (size_in_megabytes>5){
                    $('.igssize').removeClass('hidden');
                    $('#tdmfile_igsfile').filestyle('clear');
                    resetFormElement($(this))
                  }
                  else{
                    $('.igstype').addClass('hidden');
                    $('.igssize').addClass('hidden');
                  }
                }
              }
              else{
                var n;
                if (file.is("#picture1file")){n="picture1"}
                if (file.is("#picture2file")){n="picture2"}
                if (file.is("#picture3file")){n="picture3"}
                if($.inArray(ext,['png','jpg','jpeg'])==-1){
                  $('.'+n+'type').removeClass('hidden');
                  $('.'+n+'size').addClass('hidden');
                  pictureDelete(n)
                  resetFormElement($(this))
                }
                else{
                  if(size_in_megabytes>0.8){
                    resetFormElement($(this))
                  }
                  else{
                    $('.'+n+'type').addClass('hidden');
                    $('.'+n+'size').addClass('hidden');
                    $('#'+n).css('display','inline-block');
                    var files = !!this.files ? this.files : [];
                    if (!files.length || !window.FileReader) return;
                    if (/^image/.test( files[0].type)){
                      var reader = new FileReader();
                      reader.readAsDataURL(files[0]);
                      reader.onloadend = function(){
                        $("#"+n+"Preview").css("background-image", "url("+this.result+")");
                      }
                    }
                  }
                }
              }
            })
          }
          function resetFormElement(e){
            e.wrap('<form>').closest('form').get(0).reset();
            e.unwrap();
            e.stopPropagation();
            e.preventDefault();
          }
        </script>
      <% else %>
        <div style="padding: 20px 0;">
          <% if language=='en' %>
            <h3>Upload Complete</h3>
          <% elsif language=='sc' %>
            <h3>上传完成</h3>
          <% else %>
            <h3>上傳完成</h3>
          <% end %>
          <% tdmfile=@register.tdmfiles.first %>
          <%= tdmfile.igsfile.to_s.rpartition("/").last %>
        </div>
        <% if tdmfile.picture1.url!=nil %>
          <div class="picturePreview" style="background-image: url('<%= @register.tdmfiles.first.picture1.url %>');"></div>
        <% end %>
        <% if tdmfile.picture2.url!=nil %>
          <div class="picturePreview" style="background-image: url('<%= @register.tdmfiles.first.picture2.url %>');"></div>
        <% end %>
        <% if tdmfile.picture3.url!=nil %>
          <div class="picturePreview" style="background-image: url('<%= @register.tdmfiles.first.picture3.url %>');"></div>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
</div>
